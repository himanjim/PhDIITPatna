---
# Hyperledger Fabric v3.1.1
# Application-channel genesis for Channel Participation API (no system channel).
# - NO global Orderer.Addresses (V3_0 forbids it)
# - Per-orderer-org OrdererEndpoints instead
# - Raft (etcdraft) with 5 consenters
# - Orderer group includes BlockValidation policy
# - EACH orderer org defines Policies (required)

Organizations:

  # -------- ORDERER ORGS (with Policies + OrdererEndpoints) --------
  - &ECI1
    Name: ECI1
    ID: ECI1MSP
    MSPDir: /home/ubuntu/fab-election-bench/stacks/stack-v31-bft/crypto/ordererOrganizations/eci1.bench.local/msp
    Policies:
      Readers: { Type: Signature, Rule: "OR('ECI1MSP.member')" }
      Writers: { Type: Signature, Rule: "OR('ECI1MSP.member')" }
      Admins:  { Type: Signature, Rule: "OR('ECI1MSP.admin')" }
    OrdererEndpoints:
      - orderer1.eci1.bench.local:7050

  - &ECI2
    Name: ECI2
    ID: ECI2MSP
    MSPDir: /home/ubuntu/fab-election-bench/stacks/stack-v31-bft/crypto/ordererOrganizations/eci2.bench.local/msp
    Policies:
      Readers: { Type: Signature, Rule: "OR('ECI2MSP.member')" }
      Writers: { Type: Signature, Rule: "OR('ECI2MSP.member')" }
      Admins:  { Type: Signature, Rule: "OR('ECI2MSP.admin')" }
    OrdererEndpoints:
      - orderer2.eci2.bench.local:8050

  - &OPP1
    Name: OPP1
    ID: OPP1MSP
    MSPDir: /home/ubuntu/fab-election-bench/stacks/stack-v31-bft/crypto/ordererOrganizations/opp1.bench.local/msp
    Policies:
      Readers: { Type: Signature, Rule: "OR('OPP1MSP.member')" }
      Writers: { Type: Signature, Rule: "OR('OPP1MSP.member')" }
      Admins:  { Type: Signature, Rule: "OR('OPP1MSP.admin')" }
    OrdererEndpoints:
      - orderer3.opp1.bench.local:9050

  - &OPP2
    Name: OPP2
    ID: OPP2MSP
    MSPDir: /home/ubuntu/fab-election-bench/stacks/stack-v31-bft/crypto/ordererOrganizations/opp2.bench.local/msp
    Policies:
      Readers: { Type: Signature, Rule: "OR('OPP2MSP.member')" }
      Writers: { Type: Signature, Rule: "OR('OPP2MSP.member')" }
      Admins:  { Type: Signature, Rule: "OR('OPP2MSP.admin')" }
    OrdererEndpoints:
      - orderer4.opp2.bench.local:10050

  - &CIV1
    Name: CIV1
    ID: CIV1MSP
    MSPDir: /home/ubuntu/fab-election-bench/stacks/stack-v31-bft/crypto/ordererOrganizations/civ1.bench.local/msp
    Policies:
      Readers: { Type: Signature, Rule: "OR('CIV1MSP.member')" }
      Writers: { Type: Signature, Rule: "OR('CIV1MSP.member')" }
      Admins:  { Type: Signature, Rule: "OR('CIV1MSP.admin')" }
    OrdererEndpoints:
      - orderer5.civ1.bench.local:11050

  # ---------------- APPLICATION ORGS ----------------
  - &ECIAPP
    Name: ECIMSP
    ID: ECIMSP
    MSPDir: /home/ubuntu/fab-election-bench/stacks/stack-v31-bft/crypto/peerOrganizations/eci.bench.local/msp
    Policies:
      Readers: { Type: Signature, Rule: "OR('ECIMSP.member')" }
      Writers: { Type: Signature, Rule: "OR('ECIMSP.member')" }
      Admins:  { Type: Signature, Rule: "OR('ECIMSP.admin')" }
      Endorsement: { Type: Signature, Rule: "OR('ECIMSP.peer')" }

  - &OPPAPP
    Name: OppMSP
    ID: OppMSP
    MSPDir: /home/ubuntu/fab-election-bench/stacks/stack-v31-bft/crypto/peerOrganizations/opp.bench.local/msp
    Policies:
      Readers: { Type: Signature, Rule: "OR('OppMSP.member')" }
      Writers: { Type: Signature, Rule: "OR('OppMSP.member')" }
      Admins:  { Type: Signature, Rule: "OR('OppMSP.admin')" }
      Endorsement: { Type: Signature, Rule: "OR('OppMSP.peer')" }

  - &CIVAPP
    Name: CivilMSP
    ID: CivilMSP
    MSPDir: /home/ubuntu/fab-election-bench/stacks/stack-v31-bft/crypto/peerOrganizations/civil.bench.local/msp
    Policies:
      Readers: { Type: Signature, Rule: "OR('CivilMSP.member')" }
      Writers: { Type: Signature, Rule: "OR('CivilMSP.member')" }
      Admins:  { Type: Signature, Rule: "OR('CivilMSP.admin')" }
      Endorsement: { Type: Signature, Rule: "OR('CivilMSP.peer')" }

# ---------------- CAPABILITIES ----------------
Capabilities:
  Channel: &ChannelCaps
    V3_0: true
  Orderer: &OrdererCaps
    V2_0: true
  Application: &AppCaps
    V2_0: true


# ---------------- DEFAULTS ----------------
Application: &ApplicationDefaults
  Organizations:
  Policies:
    Readers: { Type: ImplicitMeta, Rule: "ANY Readers" }
    Writers: { Type: ImplicitMeta, Rule: "ANY Writers" }
    Admins:  { Type: ImplicitMeta, Rule: "MAJORITY Admins" }
    Endorsement:          { Type: ImplicitMeta, Rule: "MAJORITY Endorsement" }
    LifecycleEndorsement: { Type: ImplicitMeta, Rule: "MAJORITY Endorsement" }
  Capabilities:
    <<: *AppCaps

Orderer: &OrdererDefaults
  # Switch from Raft to SmartBFT
  OrdererType: BFT

  # Batching as per your old Raft config (tweak if your values differ)
  BatchTimeout: 2s
  BatchSize:
    MaxMessageCount: 500
    AbsoluteMaxBytes: 10 MB
    PreferredMaxBytes: 2 MB

  MaxChannels: 0

  # SmartBFT protocol options (safe defaults)
  SmartBFT:
    RequestBatchMaxCount: 100
    RequestBatchMaxBytes: 10485760
    RequestBatchMaxInterval: 50ms
    IncomingMessageBufferSize: 200
    RequestPoolSize: 400
    RequestForwardTimeout: 2s
    RequestComplainTimeout: 20s
    RequestAutoRemoveTimeout: 3m0s
    ViewChangeResendInterval: 5s
    ViewChangeTimeout: 20s
    LeaderHeartbeatTimeout: 1m0s
    LeaderHeartbeatCount: 10
    CollectTimeout: 1s

  # Each BFT node: ID, host, port, MSPID, certs
  ConsenterMapping:
    - ID: 1
      Host: orderer1.eci1.bench.local
      Port: 7050
      MSPID: ECI1MSP
      Identity: /home/ubuntu/fab-election-bench/stacks/stack-v31-bft/crypto/ordererOrganizations/eci1.bench.local/orderers/orderer1.eci1.bench.local/msp/signcerts/orderer1.eci1.bench.local-cert.pem
      ClientTLSCert: /home/ubuntu/fab-election-bench/stacks/stack-v31-bft/crypto/ordererOrganizations/eci1.bench.local/orderers/orderer1.eci1.bench.local/tls/server.crt
      ServerTLSCert: /home/ubuntu/fab-election-bench/stacks/stack-v31-bft/crypto/ordererOrganizations/eci1.bench.local/orderers/orderer1.eci1.bench.local/tls/server.crt

    - ID: 2
      Host: orderer2.eci2.bench.local
      Port: 8050
      MSPID: ECI2MSP
      Identity: /home/ubuntu/fab-election-bench/stacks/stack-v31-bft/crypto/ordererOrganizations/eci2.bench.local/orderers/orderer2.eci2.bench.local/msp/signcerts/orderer2.eci2.bench.local-cert.pem
      ClientTLSCert: /home/ubuntu/fab-election-bench/stacks/stack-v31-bft/crypto/ordererOrganizations/eci2.bench.local/orderers/orderer2.eci2.bench.local/tls/server.crt
      ServerTLSCert: /home/ubuntu/fab-election-bench/stacks/stack-v31-bft/crypto/ordererOrganizations/eci2.bench.local/orderers/orderer2.eci2.bench.local/tls/server.crt

    - ID: 3
      Host: orderer3.opp1.bench.local
      Port: 9050
      MSPID: OPP1MSP
      Identity: /home/ubuntu/fab-election-bench/stacks/stack-v31-bft/crypto/ordererOrganizations/opp1.bench.local/orderers/orderer3.opp1.bench.local/msp/signcerts/orderer3.opp1.bench.local-cert.pem
      ClientTLSCert: /home/ubuntu/fab-election-bench/stacks/stack-v31-bft/crypto/ordererOrganizations/opp1.bench.local/orderers/orderer3.opp1.bench.local/tls/server.crt
      ServerTLSCert: /home/ubuntu/fab-election-bench/stacks/stack-v31-bft/crypto/ordererOrganizations/opp1.bench.local/orderers/orderer3.opp1.bench.local/tls/server.crt

    - ID: 4
      Host: orderer4.opp2.bench.local
      Port: 10050
      MSPID: OPP2MSP
      Identity: /home/ubuntu/fab-election-bench/stacks/stack-v31-bft/crypto/ordererOrganizations/opp2.bench.local/orderers/orderer4.opp2.bench.local/msp/signcerts/orderer4.opp2.bench.local-cert.pem
      ClientTLSCert: /home/ubuntu/fab-election-bench/stacks/stack-v31-bft/crypto/ordererOrganizations/opp2.bench.local/orderers/orderer4.opp2.bench.local/tls/server.crt
      ServerTLSCert: /home/ubuntu/fab-election-bench/stacks/stack-v31-bft/crypto/ordererOrganizations/opp2.bench.local/orderers/orderer4.opp2.bench.local/tls/server.crt

    - ID: 5
      Host: orderer5.civ1.bench.local
      Port: 11050
      MSPID: CIV1MSP
      Identity: /home/ubuntu/fab-election-bench/stacks/stack-v31-bft/crypto/ordererOrganizations/civ1.bench.local/orderers/orderer5.civ1.bench.local/msp/signcerts/orderer5.civ1.bench.local-cert.pem
      ClientTLSCert: /home/ubuntu/fab-election-bench/stacks/stack-v31-bft/crypto/ordererOrganizations/civ1.bench.local/orderers/orderer5.civ1.bench.local/tls/server.crt
      ServerTLSCert: /home/ubuntu/fab-election-bench/stacks/stack-v31-bft/crypto/ordererOrganizations/civ1.bench.local/orderers/orderer5.civ1.bench.local/tls/server.crt

  Organizations:
    - *ECI1
    - *ECI2
    - *OPP1
    - *OPP2
    - *CIV1

  Policies:
    Readers:         { Type: ImplicitMeta, Rule: "ANY Readers" }
    Writers:         { Type: ImplicitMeta, Rule: "ANY Writers" }
    Admins:          { Type: ImplicitMeta, Rule: "MAJORITY Admins" }
    BlockValidation: { Type: ImplicitMeta, Rule: "ANY Writers" }

  Capabilities:
    <<: *OrdererCaps


Channel: &ChannelDefaults
  Policies:
    Readers: { Type: ImplicitMeta, Rule: "ANY Readers" }
    Writers: { Type: ImplicitMeta, Rule: "ANY Writers" }
    Admins:  { Type: ImplicitMeta, Rule: "MAJORITY Admins" }
  Capabilities:
    <<: *ChannelCaps

# ---------------- PROFILE ----------------
Profiles:
  BFTChannel:
    <<: *ChannelDefaults
    Orderer:
      <<: *OrdererDefaults
    Application:
      <<: *ApplicationDefaults
      Organizations:
        - *ECIAPP
        - *OPPAPP
        - *CIVAPP
      Capabilities:
        <<: *AppCaps


